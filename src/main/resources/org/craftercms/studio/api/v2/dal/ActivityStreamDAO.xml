<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (C) 2007-2022 Crafter Software Corporation. All Rights Reserved.
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License version 3 as published by
  ~ the Free Software Foundation.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with this program.  If not, see <http://www.gnu.org/licenses/>.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.craftercms.studio.api.v2.dal.ActivityStreamDAO">
    <resultMap id="ActivityMap" type="org.craftercms.studio.model.rest.dashboard.Activity">
        <id property="id" column="asid" />
        <result property="action" column="action" />
        <result property="actionTimestamp" column="action_timestamp" />
        <result property="itemId" column="item_id" />
        <result property="packageId" column="package_id" />
        <association property="person" column="uid" javaType="org.craftercms.studio.model.rest.Person">
            <result property="username" column="username"/>
            <result property="firstName" column="first_name" />
            <result property="lastName" column="last_name" />
            <result property="avatar" column="avatar"/>
        </association>
    </resultMap>

    <insert id="insertActivity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO activity_stream (site_id, user_id, action, action_timestamp, item_id, package_id)
        VALUES (#{siteId}, #{userId}, #{action}, IFNULL(#{actionTimestamp}, CURRENT_TIMESTAMP), #{itemId}, #{packageId});
    </insert>

    <select id="getActivitiesForUsers" resultType="int" >
        SELECT COUNT(1)
        FROM activity_stream as INNER JOIN user u ON as.user_id = u.id
        WHERE as.site_id = #{siteId}
        AND u.username in
        <foreach item="username" index="index" collection="usernames"
                 open="(" separator="," close=")">
            #{username}
        </foreach>
        <if test="toDate != null" >
            AND DATE(as.action_timestamp) &lt;= DATE(#{toDate})
        </if>
        <if test="fromDate != null">
            AND DATE(as.action_timestamp) &gt;= DATE(#{fromDate})
        </if>
    </select>

    <select id="getActivitiesForUsers" resultMap="ActivityMap" >
        SELECT
            as.id as asid, as.action, as.acton_timestamp, as.item_id, as.package_id, u.username, u.first_name,
            u.last_name, u.avatar
        FROM activity_stream as INNER JOIN user u ON as.user_id = u.id
        WHERE as.site_id = #{siteId}
        AND u.username in
        <foreach item="username" index="index" collection="usernames"
                 open="(" separator="," close=")">
            #{username}
        </foreach>
        <if test="toDate != null" >
            AND DATE(as.action_timestamp) &lt;= DATE(#{toDate})
        </if>
        <if test="fromDate != null">
            AND DATE(as.action_timestamp) &gt;= DATE(#{fromDate})
        </if>
        LIMIT #{offset}, #{limit}
    </select>
</mapper>