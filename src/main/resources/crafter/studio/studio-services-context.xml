<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (C) 2007-2019 Crafter Software Corporation. All Rights Reserved.
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as published by
  ~ the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with this program.  If not, see <http://www.gnu.org/licenses/>.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <import resource="classpath:crafter/studio/database-context.xml"/>
    <import resource="classpath:crafter/studio/studio-upgrade-context.xml"/>


      <!-- ////////////////////////////////////// -->
      <!--         logging                        -->
      <!-- ////////////////////////////////////// -->
      <bean id="cstudioLogProvider" class="org.craftercms.studio.impl.v1.log.l4j.L4jLogProvider"
            init-method="init">
      </bean>


       <bean id="cstudioServicesManager" class="org.craftercms.studio.api.v1.service.ServicesManager" />

       <bean id="cstudioRegistrableService" class="org.craftercms.studio.api.v1.service.AbstractRegistrableService"
             abstract="true" init-method="register">
              <property name="servicesManager" ref="cstudioServicesManager" />
       </bean>

    <!-- ////////////////////////////////////// -->
    <!--         Services                       -->
    <!-- ////////////////////////////////////// -->
    <bean id="cstudioContentService" class="org.craftercms.studio.impl.v1.service.content.ContentServiceImpl">
          <property name="contentRepository" ref="contentRepository" />
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="generalLockService" ref="cstudioGeneralLockService" />
        <property name="contentProcessor" ref="cstudioProcessContentExecutor" />
        <property name="dependencyService" ref="studioDependencyService"/>
        <property name="objectStateService" ref="cstudioObjectStateService" />
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager" />
        <property name="securityService" ref="cstudioSecurityService" />
        <property name="dmPageNavigationOrderService" ref="cstudioPageNavOrderService"/>
        <property name="activityService" ref="cstudioActivityService"/>
        <property name="dmContentLifeCycleService" ref="cstudioContentLifeCycleService"/>
        <property name="eventService" ref="studioEventService"/>
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="contentItemIdGenerator" ref="cstudioContentIdGenerator" />
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="dependencyDiffService" ref="cstudioDependencyDiffService" />
        <property name="contentTypeService" ref="cstudioContentTypeService" />
        <property name="entitlementValidator" ref="crafter.entitlementValidator"/>
    </bean>

    <bean id="studioDependencyService" class="org.craftercms.studio.impl.v1.service.dependency.DependencyServiceImpl">
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="contentService" ref="cstudioContentService" />
        <property name="dependencyResolver" ref="studioDependencyResolver" />
        <property name="transactionManager" ref="transactionManager" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager" />
        <property name="servicesConfig" ref="cstudioServicesConfig" />
        <property name="itemStateMapper" ref="itemStateMapper" />
        <property name="dependencyMapper" ref="dependencyMapper" />
    </bean>

    <!-- all of these beans below need to move off contentRepository and on to content service.  Repository is a very NARROW interface -->


    <bean id="cstudioTransactionServiceSimple" class="org.craftercms.studio.impl.v1.service.transaction.TransactionServiceImpl">
        <property name="contentRepository" ref="contentRepository" />
    </bean>

    <bean id="cstudioSiteServiceSimple" class="org.craftercms.studio.impl.v1.service.site.SiteServiceImpl">
        <property name="siteServiceDAL">
          <bean id="cstudioRepositorySiteServiceDAL"
                class="org.craftercms.studio.impl.v1.service.site.dal.RepositorySiteServiceDAL">
              <property name="contentService" ref="cstudioContentService" />
          </bean>
        </property>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="contentRepository" ref="contentRepository"/>
        <property name="environmentConfig" ref="cstudioEnvironmentConfig"/>
        <property name="objectStateService" ref="cstudioObjectStateService" />
        <property name="dependencyService" ref="studioDependencyService"/>
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="activityService" ref="cstudioActivityService"/>
        <property name="deploymentService" ref="cstudioDeploymentService"/>
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="dmPageNavigationOrderService" ref="cstudioPageNavOrderService"/>
        <property name="notificationService" ref="cstudioNotificationService"/>
        <property name="contentTypeService" ref="cstudioContentTypeService"/>
        <property name="importService" ref="cstudioImportService"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="rebuildRepositoryMetadata" ref="studioRebuildRepositoryMetadata"/>
        <property name="syncDatabaseWithRepository" ref="studioSyncDatabaseWithRepository" />
        <property name="studioConfiguration" ref="studioConfiguration"/>
        <property name="eventService" ref="studioEventService"/>
        <property name="previewDeployer" ref="previewDeployer"/>
        <property name="entitlementValidator" ref="crafter.entitlementValidator"/>
        <property name="groupServiceInternal" ref="groupServiceInternal" />
        <property name="userServiceInternal" ref="userServiceInternal"/>
        <property name="upgradeManager" ref="upgradeManager"/>
    </bean>

    <bean id="cstudioImportService" class="org.craftercms.studio.impl.v1.service.content.ImportServiceImpl">
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="contentRepository" ref="contentRepository"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="objectStateService" ref="cstudioObjectStateService"/>
        <property name="dmPublishService" ref="cstudioDmPublishService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioWorkflowService" class="org.craftercms.studio.impl.v1.service.workflow.WorkflowServiceImpl">
        <property name="notificationService" ref="cstudioNotificationService" />
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="deploymentService" ref="cstudioDeploymentService"/>
        <property name="dependencyService" ref="studioDependencyService"/>
        <property name="dmFilterWrapper" ref="cstudioDmFilterWrapper"/>
        <property name="objectStateService" ref="cstudioObjectStateService"/>
        <property name="dmPublishService" ref="cstudioDmPublishService"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="workflowProcessor" ref="cstudioWorkflowProcessor"/>
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="activityService" ref="cstudioActivityService" />
    </bean>

     <bean id="cstudioDeploymentService" class="org.craftercms.studio.impl.v1.service.deployment.DeploymentServiceImpl" >
         <property name="contentService" ref="cstudioContentService"/>
         <property name="activityService" ref="cstudioActivityService" />
         <property name="servicesConfig" ref="cstudioServicesConfig"/>
         <property name="dependencyService" ref="studioDependencyService" />
         <property name="dmFilterWrapper" ref="cstudioDmFilterWrapper" />
         <property name="siteService" ref="cstudioSiteServiceSimple" />
         <property name="objectStateService" ref="cstudioObjectStateService" />
         <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
         <property name="contentRepository" ref="contentRepository"/>
         <property name="dmPublishService" ref="cstudioDmPublishService"/>
         <property name="securityService" ref="cstudioSecurityService"/>
         <property name="deployContentToEnvironmentStoreJob" ref="cstudioDeployContentToEnvironmentJobs"/>
         <property name="notificationService" ref="cstudioNotificationService"/>
         <property name="eventService" ref="studioEventService"/>
         <property name="deploymentHistoryProvider" ref="contentRepository"/>
         <property name="studioConfiguration" ref="studioConfiguration" />
         <property name="publishRequestMapper" ref="publishRequestMapper" />
     </bean>

    <bean id="cstudioNotificationService"
          class="org.craftercms.studio.impl.v2.service.notification.NotificationServiceImpl"  init-method="init">
        <property name="emailMessages" ref="cstudioEmailMessageQueue" />
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioServicesConfig" class="org.craftercms.studio.impl.v1.service.configuration.ServicesConfigImpl" >
        <property name="contentService" ref="cstudioContentService"/>
        <property name="contentTypesConfig" ref="cstudioContentTypesConfig"/>
        <property name="contentRepository" ref="contentRepository"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioEnvironmentConfig" class="org.craftercms.studio.impl.v1.service.configuration.SiteEnvironmentConfigImpl" >
        <property name="contentService" ref="cstudioContentService"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="studioConfiguration" ref="studioConfiguration"/>
    </bean>

    <bean id="cstudioActivityService" class="org.craftercms.studio.impl.v1.service.activity.ActivityServiceImpl"
          parent="cstudioRegistrableService">
        <property name="contentService" ref="cstudioContentService" />
        <property name="securityService" ref="cstudioSecurityService" />
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="deploymentService" ref="cstudioDeploymentService" />
        <property name="auditFeedMapper" ref="auditFeedMapper" />
    </bean>

    <bean id="cstudioDependencyDiffService" class="org.craftercms.studio.impl.v1.service.dependency.DependencyDiffServiceImpl">
        <property name="dependencyService" ref="studioDependencyService" />
    </bean>

    <bean id="cstudioObjectStateService" class="org.craftercms.studio.impl.v1.service.objectstate.ObjectStateServiceImpl"
          parent="cstudioRegistrableService">
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="itemStateMapper" ref="itemStateMapper" />
    </bean>

    <bean id="cstudioGeneralLockService" class="org.craftercms.studio.impl.v1.service.GeneralLockServiceImpl"
          parent="cstudioRegistrableService" />

    <bean id="cstudioSecurityService" class="org.craftercms.studio.impl.v1.service.security.SecurityServiceImpl">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="contentTypeService" ref="cstudioContentTypeService"/>
        <property name="generalLockService" ref="cstudioGeneralLockService" />
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="emailService" ref="mailSender"/>
        <property name="emailServiceNoAuth" ref="mailSenderNoAuth"/>
        <property name="userDetailsManager" ref="studioUserDetailsManager" />
        <property name="freeMarkerConfig" ref="crafter.freeMarkerConfigFactory"/>
        <property name="activityService" ref="cstudioActivityService" />
        <property name="groupService" ref="groupService" />
        <property name="userServiceInternal" ref="userServiceInternal" />
        <property name="authenticationChain" ref="crafter.studioAuthenticationChain" />
        <property name="configurationService" ref="configurationService" />
    </bean>

    <bean id="cstudioContentTypeService" class="org.craftercms.studio.impl.v1.service.content.ContentTypeServiceImpl" >
        <property name="contentService" ref="cstudioContentService"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="contentTypesConfig" ref="cstudioContentTypesConfig"/>
        <property name="securityService" ref="cstudioSecurityService" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioContentTypesConfig" class="org.craftercms.studio.impl.v1.service.configuration.ContentTypesConfigImpl" >
        <property name="contentService" ref="cstudioContentService"/>
        <property name="generalLockService" ref="cstudioGeneralLockService" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioDmPublishService" class="org.craftercms.studio.impl.v1.service.deployment.DmPublishServiceImpl"
          parent="cstudioRegistrableService">
         <property name="securityService" ref="cstudioSecurityService" />
        <property name="deploymentService" ref="cstudioDeploymentService"/>
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="contentService" ref="cstudioContentService"/>
        <property name="contentRepository" ref="contentRepository" />
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="objectStateService" ref="cstudioObjectStateService"/>
        <property name="dependencyService" ref="studioDependencyService" />
    </bean>

    <bean id="cstudioPageNavOrderService" class="org.craftercms.studio.impl.v1.service.content.DmPageNavigationOrderServiceImpl"
          parent="cstudioRegistrableService">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="navigationOrderSequenceMapper" ref="navigationOrderSequenceMapper" />
    </bean>

    <bean id="cstudioContentLifeCycleService" class="org.craftercms.studio.impl.v1.service.content.DmContentLifeCycleServiceImpl"
          parent="cstudioRegistrableService">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="scriptObjects">
            <map>
            </map>
        </property>
        <property name="scriptExecutor" ref="studioGroovyScriptExecutor"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioClipboardService" class="org.craftercms.studio.impl.v1.service.clipboard.ClipboardServiceImpl"
            parent="cstudioRegistrableService">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="workflowService" ref="cstudioWorkflowService" />
    </bean>

    <bean id="studioEventService" class="org.craftercms.studio.impl.v1.service.event.EventServiceImpl" />

    <bean id="studioMonitorService" class="org.craftercms.studio.impl.v1.service.monitor.MonitorServiceImpl"/>

    <bean id="studioCmisService" class="org.craftercms.studio.impl.v1.service.cmis.CmisServiceImpl" >
        <property name="studioConfiguration" ref="studioConfiguration"/>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="configurationService" class="org.craftercms.studio.impl.v2.service.configuration.ConfigurationServiceImpl">
        <property name="contentService" ref="cstudioContentService" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="groupService" class="org.craftercms.studio.impl.v2.service.security.GroupServiceImpl">
        <property name="configurationService" ref="configurationService" />
        <property name="generalLockService" ref="cstudioGeneralLockService" />
        <property name="groupServiceInternal" ref="groupServiceInternal" />
        <property name="userServiceInternal" ref="userServiceInternal" />
        <property name="organizationServiceInternal" ref="organizationServiceInternal" />
    </bean>

    <bean id="groupServiceInternal"
          class="org.craftercms.studio.impl.v2.service.security.internal.GroupServiceInternalImpl">
        <property name="userServiceInternal" ref="userServiceInternal" />
        <property name="configurationService" ref="configurationService"/>
        <property name="groupDao" ref="groupDAO" />
    </bean>

    <bean id="userService" class="org.craftercms.studio.impl.v2.service.security.UserServiceImpl">
        <property name="userServiceInternal" ref="userServiceInternal" />
        <property name="groupServiceInternal" ref="groupServiceInternal" />
        <property name="configurationService" ref="configurationService" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="entitlementValidator" ref="crafter.entitlementValidator"/>
        <property name="generalLockService" ref="cstudioGeneralLockService" />
        <property name="securityService" ref="cstudioSecurityService" />
    </bean>

    <bean id="userServiceInternal"
          class="org.craftercms.studio.impl.v2.service.security.internal.UserServiceInternalImpl">
        <property name="groupServiceInternal" ref="groupServiceInternal" />
        <property name="userDao" ref="userDAO" />
    </bean>

    <bean id="organizationServiceInternal"
          class="org.craftercms.studio.impl.v2.service.security.internal.OrganizationServiceInternalImpl">

    </bean>

    <bean id="uiServiceInternal" class="org.craftercms.studio.impl.v2.service.ui.internal.UiServiceInternalImpl">
        <property name="studioConfiguration" ref="studioConfiguration"/>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="uiService" class="org.craftercms.studio.impl.v2.service.ui.UiServiceImpl">
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="uiServiceInternal" ref="uiServiceInternal"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="instanceService" class="org.craftercms.studio.impl.v2.service.system.InstanceServiceImpl">
        <property name="metaDAO" ref="metaDAO" />
    </bean>

    <bean id="clusterManagementService"
          class="org.craftercms.studio.impl.v2.service.cluster.ClusterManagementServiceImpl">
        <property name="clusterManagementServiceInternal" ref="clusterManagementServiceInternal" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
    </bean>

    <bean id="clusterManagementServiceInternal"
          class="org.craftercms.studio.impl.v2.service.cluster.internal.ClusterManagementServiceInternalImpl">
        <property name="clusterDao" ref="clusterDao" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="sitesService" class="org.craftercms.studio.impl.v2.service.site.SitesServiceImpl">
        <property name="sitesServiceInternal" ref="sitesServiceInternal"/>
    </bean>

    <bean id="sitesServiceInternal"
          class="org.craftercms.studio.impl.v2.service.site.internal.SitesServiceInternalImpl">
        <property name="contentRepository" ref="contentRepository" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--      Managers                          -->
    <!-- ////////////////////////////////////// -->
    <bean id="cstudioObjectMetadataManager" class="org.craftercms.studio.impl.v1.service.content.ObjectMetadataManagerImpl">
        <property name="itemMetadataMapper" ref="itemMetadataMapper"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--       Content ID Generator                   -->
    <!-- ////////////////////////////////////// -->

    <bean id="cstudioContentIdGenerator" class="org.craftercms.studio.impl.v1.service.content.ContentItemIdGeneratorImpl"
          parent="cstudioRegistrableService"/>

    <!-- ////////////////////// -->
    <!-- Email  -->
    <!-- ////////////////////// -->
    <bean id="cstudioEmailMessageQueue" class="org.craftercms.studio.api.v1.to.EmailMessageQueueTo">
    </bean>

    <bean id="cstudioEmailMessageSender" class="org.craftercms.studio.impl.v1.job.EmailMessageSender" init-method="initThread" destroy-method="shutdown">
        <property name="emailMessages" ref="cstudioEmailMessageQueue" />
        <property name="emailService" ref="mailSender" />
        <property name="emailServiceNoAuth" ref="mailSenderNoAuth" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="mailSender" class="org.springframework.mail.javamail.JavaMailSenderImpl">
      <property name="host" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_HOST)}" />
      <property name="port" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_PORT)}" />
      <property name="username" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_USERNAME)}" />
      <property name="password" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_PASSWORD)}" />
      <property name="javaMailProperties">
        <props>
          <prop key="mail.smtp.auth">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_SMTP_AUTH)}</prop>
          <prop key="mail.smtp.starttls.enable">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_SMTP_START_TLS_ENABLE)}</prop>
            <prop key="mail.smtp.ehlo">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_SMTP_EHLO)}</prop>
            <prop key="mail.debug">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_DEBUG)}</prop>
        </props>
      </property>
    </bean>

    <bean id="mailSenderNoAuth" class="org.springframework.mail.javamail.JavaMailSenderImpl">
        <property name="host" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_HOST)}" />
        <property name="port" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_PORT)}" />
        <property name="javaMailProperties">
            <props>
                <prop key="mail.smtp.auth">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_SMTP_AUTH)}</prop>
                <prop key="mail.smtp.starttls.enable">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_SMTP_START_TLS_ENABLE)}</prop>
                <prop key="mail.smtp.ehlo">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_SMTP_EHLO)}</prop>
                <prop key="mail.debug">#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).MAIL_DEBUG)}</prop>
            </props>
        </property>
    </bean>


    <!-- continue refactoring -->
    <!-- Jobs -->

    <bean id="studioPublisherTaskExecutor"
          class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
        <property name="corePoolSize"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).PUBLISHING_THREAD_POOL_CORE_POOL_SIZE)}" />
        <property name="maxPoolSize"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).PUBLISHING_THREAD_POOL_MAX_POOL_SIZE)}" />
        <property name="threadNamePrefix" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).PUBLISHING_THREAD_POOL_NAME_PREFIX)}" />
    </bean>

    <bean id="cstudioDeployContentToEnvironmentJobs" class="org.craftercms.studio.impl.v1.service.deployment.job.DeployContentToEnvironmentStore">
        <property name="publishingManager" ref="cstudioPublishingManager" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="generalLockService" ref="cstudioGeneralLockService"/>
        <property name="notificationService" ref="cstudioNotificationService"/>
        <property name="eventService" ref="studioEventService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="activityService" ref="cstudioActivityService" />
        <property name="servicesConfig" ref="cstudioServicesConfig" />
        <property name="taskExecutor" ref="studioPublisherTaskExecutor" />
    </bean>

    <bean id="studioNodeSyncTaskExecutor"
          class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
        <property name="corePoolSize"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_THREAD_POOL_CORE_POOL_SIZE)}" />
        <property name="maxPoolSize"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_THREAD_POOL_MAX_POOL_SIZE)}" />
        <property name="threadNamePrefix"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_THREAD_POOL_NAME_PREFIX)}" />
    </bean>

    <bean id="studioClusterSandboxSyncJob"
          class="org.craftercms.studio.impl.v2.service.cluster.StudioClusterSyncJobImpl">
        <property name="taskExecutor" ref="studioNodeSyncTaskExecutor" />
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="previewDeployer" ref="previewDeployer" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="servicesConfig" ref="cstudioServicesConfig" />
        <property name="clusterDAO" ref="clusterDao" />
        <property name="repositoryType" value="SANDBOX" />
    </bean>

    <bean id="studioClusterPublishedSyncJob"
          class="org.craftercms.studio.impl.v2.service.cluster.StudioClusterSyncJobImpl">
        <property name="taskExecutor" ref="studioNodeSyncTaskExecutor" />
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="previewDeployer" ref="previewDeployer" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="servicesConfig" ref="cstudioServicesConfig" />
        <property name="clusterDAO" ref="clusterDao" />
        <property name="repositoryType" value="PUBLISHED" />
    </bean>

    <bean id="studioClusterNodeHeartbeatJob"
          class="org.craftercms.studio.impl.v2.service.cluster.StudioNodeHeartbeatJob">
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="clusterDAO" ref="clusterDao" />
    </bean>
    
    <bean id="studioClusterNodeInactivityCheckJob" 
          class="org.craftercms.studio.impl.v2.service.cluster.StudioNodeActivityCheckJob">
        <property name="studioConfiguration" ref="studioConfiguration"/>
        <property name="clusterDao" ref="clusterDao"/>
    </bean>

    <bean id="studioRepositoryCleanupJob" class="org.craftercms.studio.impl.v1.repository.job.RepositoryCleanupJob">
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="contentRepository" ref="contentRepository"/>
    </bean>

    <!-- scheduled actions -->
    <bean id="cstudioDeployContentToEnvironmentJobsScheduled" class="org.springframework.scheduling.quartz.SimpleTriggerFactoryBean" >
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean" >
                <property name="targetObject" ref="cstudioDeployContentToEnvironmentJobs"/>
                <property name="targetMethod" value="execute"/>
                <property name="concurrent" value="false"/>
            </bean>
        </property>
        <property name="repeatInterval" value="10000" />
        <property name="startDelay" value="2000" />
    </bean>

    <bean id="cstudioClusterSandboxSyncJobsScheduled"
          class="org.springframework.scheduling.quartz.SimpleTriggerFactoryBean" >
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean" >
                <property name="targetObject" ref="studioClusterSandboxSyncJob"/>
                <property name="targetMethod" value="run"/>
                <property name="concurrent" value="false"/>
            </bean>
        </property>
        <property name="repeatInterval"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_SANDBOX_SYNC_JOB_INTERVAL)}" />
        <property name="startDelay" value="0" />
    </bean>

    <bean id="cstudioClusterPublishedSyncJobsScheduled"
          class="org.springframework.scheduling.quartz.SimpleTriggerFactoryBean" >
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean" >
                <property name="targetObject" ref="studioClusterPublishedSyncJob"/>
                <property name="targetMethod" value="run"/>
                <property name="concurrent" value="false"/>
            </bean>
        </property>
        <property name="repeatInterval"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_PUBLISHED_SYNC_JOB_INTERVAL)}" />
        <property name="startDelay" value="0" />
    </bean>

    <bean id="cstudioClusterNodeHeartbeatJobsScheduled"
          class="org.springframework.scheduling.quartz.SimpleTriggerFactoryBean" >
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean" >
                <property name="targetObject" ref="studioClusterNodeHeartbeatJob"/>
                <property name="targetMethod" value="run"/>
                <property name="concurrent" value="false"/>
            </bean>
        </property>
        <property name="repeatInterval"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_HEARTBEAT_JOB_INTERVAL)}" />
        <property name="startDelay" value="0" />
    </bean>

    <bean id="cstudioClusterNodeInactivityCheckJobsScheduled"
          class="org.springframework.scheduling.quartz.SimpleTriggerFactoryBean" >
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean" >
                <property name="targetObject" ref="studioClusterNodeInactivityCheckJob"/>
                <property name="targetMethod" value="run"/>
                <property name="concurrent" value="false"/>
            </bean>
        </property>
        <property name="repeatInterval"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CLUSTERING_INACTIVITY_CHECK_JOB_INTERVAL)}" />
        <property name="startDelay" value="0" />
    </bean>

    <bean id="studioRepositoryCleanupJobTrigger" class="org.springframework.scheduling.quartz.CronTriggerFactoryBean">
        <property name="jobDetail">
            <bean class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean" >
                <property name="targetObject" ref="studioRepositoryCleanupJob"/>
                <property name="targetMethod" value="cleanupAllRepositories"/>
                <property name="concurrent" value="false"/>
            </bean>
        </property>
        <property name="cronExpression"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).REPO_CLEANUP_CRON)}"/>
    </bean>

    <bean id="studioSchedulerFactoryBean" name="studioSchedulerFactoryBean" class="org.craftercms.studio.impl.v1.util.spring.context.StudioSchedulerFactoryBean" destroy-method="destroy">
        <property name="triggers">
            <list>
                <ref bean="cstudioDeployContentToEnvironmentJobsScheduled" />
                <ref bean="studioRepositoryCleanupJobTrigger"/>
                <ref bean="cstudioClusterSandboxSyncJobsScheduled" />
                <ref bean="cstudioClusterPublishedSyncJobsScheduled" />
                <ref bean="cstudioClusterNodeHeartbeatJobsScheduled" />
                <ref bean="cstudioClusterNodeInactivityCheckJobsScheduled" />
            </list>
        </property>
        <property name="waitForJobsToCompleteOnShutdown" value="false" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         workflow                       -->
    <!-- ////////////////////////////////////// -->
    <bean id="cstudioWorkflowProcessor" class="org.craftercms.studio.impl.v1.service.workflow.WorkflowProcessor">
        <property name="objectStateService" ref="cstudioObjectStateService"/>
         <property name="securityService" ref="cstudioSecurityService" />
        <property name="contentService" ref="cstudioContentService"/>
        <property name="workflowService" ref="cstudioWorkflowService"/>
        <property name="dmPublishService" ref="cstudioDmPublishService"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         repository layer               -->
    <!-- ////////////////////////////////////// -->
    <bean id="contentRepository"
          class="org.craftercms.studio.impl.v1.repository.git.GitContentRepository" init-method="bootstrap">
        <property name="studioConfiguration" ref="studioConfiguration"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="remoteRepositoryMapper" ref="remoteRepositoryMapper" />
        <property name="gitLogMapper" ref="gitLogMapper" />
        <property name="userServiceInternal" ref="userServiceInternal" />
        <property name="securityService" ref="cstudioSecurityService" />
        <property name="siteFeedMapper" ref="siteFeedMapper" />
    </bean>

    <!-- /////// -->
    <!-- Cluster -->
    <!-- /////// -->
    <bean id="clusterNodeRegistration"
          class="org.craftercms.studio.impl.v2.service.cluster.ClusterNodeRegistrationImpl" init-method="init"
          destroy-method="destroy" depends-on="studioMariaDBService">
        <property name="clusterDao" ref="clusterDao" />
        <property name="metaDao" ref="metaDAO" />
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--       Object type filters                   -->
    <!-- ////////////////////////////////////// -->
    <!-- this should be refactored and moved in to repo based config -->
    <!-- DM filters -->
    <bean id="cstudioDmFilterWrapper" class="org.craftercms.studio.api.v1.util.filter.DmFilterWrapperImpl">
        <property name="filterMap">
            <map>
                <entry key="pages">
                    <ref bean="cstudioPagesFilter"/>
                </entry>
                <entry key="components">
                    <ref bean="cstudioComponentsFilter"/>
                </entry>
                <entry key="documents">
                    <ref bean="cstudioDocumentsFilter"/>
                </entry>
                <entry key="all">
                    <ref bean="cstudioAllFilter"/>
                </entry>
            </map>
        </property>
        <property name="defaultFilter" ref="cstudioAllFilter"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="servicesManager" ref="cstudioServicesManager" />
    </bean>

    <bean id="cstudioPagesFilter" class="org.craftercms.studio.api.v1.util.filter.PageFilter">
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioComponentsFilter" class="org.craftercms.studio.api.v1.util.filter.ComponentFilter">
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioDocumentsFilter" class="org.craftercms.studio.api.v1.util.filter.DocumentFilter">
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <bean id="cstudioAllFilter" class="org.craftercms.studio.api.v1.util.filter.AllFilter">
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--           Action Executors             -->
    <!-- ////////////////////////////////////// -->
    <bean id="cstudioProcessContentExecutor" class="org.craftercms.studio.impl.v1.executor.ProcessContentExecutorImpl">
        <property name="processorChains">
            <map>
                <entry key="assetContent"><ref bean="cstudioAssetContentProcessorPipeline"/></entry>
                <entry key="assetContentCleanDraft"><ref bean="cstudioAssetCleanContentProcessorPipeline"/></entry>
                <entry key="plainContent"><ref bean="cstudioPlainContentProcessorPipeline"/></entry>
                <entry key="formContent"><ref bean="cstudioFormContentProcessorPipeline"/></entry>
                <entry key="previewformContent"><ref bean="cstudioPreviewFormContentProcessorPipeline"/></entry>
                <entry key="importContent"><ref bean="cstudioImportContentProcessorPipeline"/></entry>
            </map>
        </property>
         <property name="securityService" ref="cstudioSecurityService" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--       Content processor pipelines      -->
    <!-- ////////////////////////////////////// -->
    <bean id="cstudioAssetContentProcessorPipeline" class="org.craftercms.studio.impl.v1.content.pipeline.ContentProcessorPipelineImpl">
        <property name="chain">
            <list>
                <ref bean="cstudioFileFolderPathProcessor"></ref>
                <ref bean="cstudioCheckImageSizeProcessor"></ref>
                <ref bean="cstudioAssetDmContentProcessor"></ref>
                <ref bean="cstudioExtractAssetDependencyProcessor"></ref>
                <ref bean="cstudioPostActivityProcessor"></ref>
                <ref bean="cstudioInvalidateCacheProcessor"></ref>
            </list>
        </property>
    </bean>

    <bean id="cstudioAssetCleanContentProcessorPipeline" class="org.craftercms.studio.impl.v1.content.pipeline.ContentProcessorPipelineImpl">
        <property name="chain">
            <list>
                <ref bean="cstudioFileFolderPathProcessor"></ref>
                <ref bean="cstudioCheckImageSizeProcessor"></ref>
                <ref bean="cstudioAssetDmContentProcessor"></ref>
                <ref bean="cstudioCleanPreviewContentProcessor"></ref>
                <ref bean="cstudioPostActivityProcessor"></ref>
                <ref bean="cstudioInvalidateCacheProcessor"></ref>
            </list>
        </property>
    </bean>

    <bean id="cstudioPlainContentProcessorPipeline" class="org.craftercms.studio.impl.v1.content.pipeline.ContentProcessorPipelineImpl">
        <property name="chain">
            <list>
                <ref bean="cstudioFileFolderPathProcessor"></ref>
                <ref bean="cstudioFormDmContentProcessor"></ref>
            </list>
        </property>
    </bean>

    <bean id="cstudioFormContentProcessorPipeline" class="org.craftercms.studio.impl.v1.content.pipeline.ContentProcessorPipelineImpl">
        <property name="chain">
            <list>
                <ref bean="cstudioExtractParamsProcessor"></ref>
                <ref bean="cstudioFormNavOrderProcessor"></ref>
                <ref bean="cstudioFileFolderPathProcessor"></ref>
                <ref bean="cstudioCleanWorkContentProcessor"></ref>
                <ref bean="cstudioFormDmContentProcessor"></ref>
                <ref bean="cstudioCleanPreviewContentProcessor"></ref>
                <ref bean="cstudioExtractDependencyProcessor"></ref>
                <ref bean="cstudioDmWorkflowProcessor"></ref>
                <ref bean="cstudioPostActivityProcessor"></ref>
                <ref bean="cstudioContentLifeCycleProcessor"></ref>
                <ref bean="cstudioInvalidateCacheProcessor"></ref>
            </list>
        </property>
    </bean>

    <bean id="cstudioPreviewFormContentProcessorPipeline" class="org.craftercms.studio.impl.v1.content.pipeline.ContentProcessorPipelineImpl">
        <property name="chain">
            <list>
                <ref bean="cstudioExtractParamsProcessor"></ref>
                <ref bean="cstudioFormDmContentProcessor"></ref>
            </list>
        </property>
    </bean>

    <bean id="cstudioImportContentProcessorPipeline" class="org.craftercms.studio.impl.v1.content.pipeline.ContentProcessorPipelineImpl">
        <property name="chain">
            <list>
                <ref bean="cstudioExtractParamsProcessor"></ref>
                <ref bean="cstudioFormNavOrderProcessor"></ref>
                <ref bean="cstudioFileFolderPathProcessor"></ref>
                <ref bean="cstudioExtractDependencyProcessor"></ref>
                <ref bean="cstudioPostActivityProcessor"></ref>
                <ref bean="cstudioContentLifeCycleProcessor"></ref>
                <ref bean="cstudioInvalidateCacheProcessor"></ref>
            </list>
        </property>
    </bean>
    <!-- ///////////////////////////// -->
    <!--       Content processors      -->
    <!-- //////////////////////////// -->
    <bean id="cstudioFileFolderPathProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.FileFolderPathProcessor"/>

    <bean id="cstudioCheckImageSizeProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.CheckImageSizeProcessor"/>

    <bean id="cstudioAssetDmContentProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.AssetDmContentProcessor">
        <property name="workflowService" ref="cstudioWorkflowService" />
        <property name="contentService" ref="cstudioContentService" />
        <property name="objectStateService" ref="cstudioObjectStateService"/>
        <property name="servicesConfig" ref="cstudioServicesConfig" />
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager" />
        <property name="contentRepository" ref="contentRepository"/>
    </bean>

    <bean id="cstudioExtractAssetDependencyProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.ExtractAssetDependencyProcessor">
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="dependencyService" ref="studioDependencyService" />
    </bean>

    <bean id="cstudioPostActivityProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.PostActivityProcessor">
        <property name="activityService" ref="cstudioActivityService"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
    </bean>

    <bean id="cstudioInvalidateCacheProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.InvalidateCacheProcessor">
    </bean>

    <bean id="cstudioCleanPreviewContentProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.CleanPreviewContentProcessor">
    </bean>

    <bean id="cstudioFormDmContentProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.FormDmContentProcessor">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="workflowService" ref="cstudioWorkflowService"/>
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="contentRepository" ref="contentRepository"/>
    </bean>

    <bean id="cstudioExtractParamsProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.ExtractParamsProcessor">
        <property name="params">
            <map>
                <entry><key><value>fileName</value></key><value>file-name</value></entry>
                <entry><key><value>contentType</value></key><value>content-type</value></entry>
            </map>
        </property>
    </bean>

    <bean id="cstudioFormNavOrderProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.FormNavOrderProcessor">
        <property name="pageNavOrderService" ref="cstudioPageNavOrderService" />
    </bean>

    <bean id="cstudioCleanWorkContentProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.CleanWorkContentProcessor"/>

    <bean id="cstudioExtractDependencyProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.ExtractDependencyProcessor">
        <property name="dependencyService" ref="studioDependencyService"/>
    </bean>

    <bean id="cstudioDmWorkflowProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.DmWorkflowProcessor"/>

    <bean id="cstudioContentLifeCycleProcessor" class="org.craftercms.studio.impl.v1.content.pipeline.ContentLifeCycleProcessor">
        <property name="dmContentLifeCycleService" ref="cstudioContentLifeCycleService"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--          preview deployer              -->
    <!-- ////////////////////////////////////// -->
    <bean id="previewDeployer" class="org.craftercms.studio.impl.v1.deployment.PreviewDeployerImpl" init-method="subscribeToPreviewSyncEvents">
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="eventService" ref="studioEventService"/>
        <property name="beanName" value="previewDeployer"/>
    </bean>

    <!-- ////////////////////////////////////////// -->
    <!--          Environment deployer              -->
    <!-- ////////////////////////////////////////// -->
    <bean id="environmentDeployer" class="org.craftercms.studio.impl.v1.deployment.EnvironmentDeployer" init-method="subscribeToPublishToEnvironmentEvents">
        <property name="contentRepository" ref="contentRepository" />
        <property name="eventService" ref="studioEventService" />
        <property name="beanName" value="environmentDeployer" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         publishing manager             -->
    <!-- ////////////////////////////////////// -->
    <bean id="cstudioPublishingManager" class="org.craftercms.studio.impl.v1.service.deployment.PublishingManagerImpl">
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="objectStateService" ref="cstudioObjectStateService" />
        <property name="contentService" ref="cstudioContentService"/>
        <property name="deploymentService" ref="cstudioDeploymentService"/>
        <property name="contentRepository" ref="contentRepository"/>
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="servicesConfig" ref="cstudioServicesConfig"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="deploymentHistoryProvider" ref="contentRepository" />
        <property name="dependencyService" ref="studioDependencyService" />
        <property name="publishRequestMapper" ref="publishRequestMapper" />
    </bean>

    <bean id="cstudioDeploymentEventLoggerListener" class="org.craftercms.studio.impl.v1.ebus.DeploymentEventLoggerListener" init-method="subscribeToDeploymentEngineDeployEvents">
        <property name="eventService" ref="studioEventService"/>
        <property name="beanName" value="cstudioDeploymentEventLoggerListener" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         Dependencies                   -->
    <!-- ////////////////////////////////////// -->
    <bean id="studioDependencyResolver" class="org.craftercms.studio.impl.v1.service.dependency.RegexDependencyResolver">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="studioConfiguration" ref="studioConfiguration" />
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         AWS                            -->
    <!-- ////////////////////////////////////// -->
    <bean id="studioTranscoderProfileLoader" class="org.craftercms.studio.impl.v1.util.config.profiles.SiteAwareConfigProfileLoader">
        <property name="profilesPath"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_SITE_AWS_CONFIGURATION_PATH)}"/>
        <property name="profileMapper">
            <bean class="org.craftercms.studio.impl.v1.aws.elastictranscoder.TranscoderProfileMapper"/>
        </property>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="studioMediaConvertProfileLoader" class="org.craftercms.studio.impl.v1.util.config.profiles.SiteAwareConfigProfileLoader">
        <property name="profilesPath" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_SITE_AWS_CONFIGURATION_PATH)}"/>
        <property name="profileMapper">
            <bean class="org.craftercms.studio.impl.v1.aws.mediaconvert.MediaConvertProfileMapper"/>
        </property>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="studioS3ProfileLoader" class="org.craftercms.studio.impl.v1.util.config.profiles.SiteAwareConfigProfileLoader">
        <property name="profilesPath" value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_SITE_AWS_CONFIGURATION_PATH)}"/>
        <property name="profileMapper">
            <bean class="org.craftercms.commons.config.profiles.aws.S3ProfileMapper"/>
        </property>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="studioElasticTranscoder" class="org.craftercms.studio.impl.v1.aws.elastictranscoder.ElasticTranscoderImpl"/>

    <bean id="studioElasticTranscoderService" class="org.craftercms.studio.impl.v1.service.aws.ElasticTranscoderServiceImpl">
        <property name="profileLoader" ref="studioTranscoderProfileLoader"/>
        <property name="transcoder" ref="studioElasticTranscoder"/>
    </bean>

    <bean id="studioS3Service" class="org.craftercms.studio.impl.v1.service.aws.S3ServiceImpl">
        <property name="profileLoader" ref="studioS3ProfileLoader"/>
    </bean>

    <!-- v2 Service -->
    <bean id="awsS3Service" class="org.craftercms.studio.impl.v2.service.aws.s3.AwsS3ServiceImpl">
        <property name="profileLoader" ref="studioS3ProfileLoader"/>
    </bean>

    <bean id="studioMediaConvert" class="org.craftercms.studio.impl.v1.aws.mediaconvert.MediaConvertImpl"/>

    <bean id="studioMediaConvertService" class="org.craftercms.studio.impl.v1.service.aws.MediaConvertServiceImpl">
        <property name="profileLoader" ref="studioMediaConvertProfileLoader"/>
        <property name="mediaConvert" ref="studioMediaConvert"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         BOX                            -->
    <!-- ////////////////////////////////////// -->
    <bean id="studioBoxProfileLoader" class="org.craftercms.studio.impl.v1.util.config.profiles.SiteAwareConfigProfileLoader">
        <property name="profilesPath"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_SITE_BOX_CONFIGURATION_PATH)}"/>
        <property name="profileMapper">
            <bean class="org.craftercms.commons.config.profiles.box.BoxProfileMapper"/>
        </property>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="studioBoxService" class="org.craftercms.studio.impl.v1.service.box.BoxServiceImpl">
        <property name="profileLoader" ref="studioBoxProfileLoader"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--                 WEBDAV                 -->
    <!-- ////////////////////////////////////// -->
    <!-- ////////////////////////////////////// -->
    <bean id="studioWebDavProfileLoader" class="org.craftercms.studio.impl.v1.util.config.profiles.SiteAwareConfigProfileLoader">
        <property name="profilesPath"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_SITE_WEBDAV_CONFIGURATION_PATH)}"/>
        <property name="profileMapper">
            <bean class="org.craftercms.commons.config.profiles.webdav.WebDavProfileMappper"/>
        </property>
        <property name="contentService" ref="cstudioContentService"/>
    </bean>

    <bean id="studioWebDavService" class="org.craftercms.studio.impl.v1.service.webdav.WebDavServiceImpl">
        <property name="profileLoader" ref="studioWebDavProfileLoader"/>
    </bean>

    <!-- Utilities -->
    <bean id="studioApplicationContextProvider" class="org.craftercms.studio.impl.v1.util.spring.context.ApplicationContextProvider"></bean>

    <bean id="studioRebuildRepositoryMetadata" class="org.craftercms.studio.impl.v1.repository.job.RebuildRepositoryMetadata">
        <property name="contentService" ref="cstudioContentService"/>
        <property name="dependencyService" ref="studioDependencyService"/>
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="objectStateService" ref="cstudioObjectStateService"/>
        <property name="securityService" ref="cstudioSecurityService"/>
        <property name="taskExecutor" ref="studioTaskExecutor" />
        <property name="studioConfiguration" ref="studioConfiguration" />
        <property name="siteService" ref="cstudioSiteServiceSimple" />
        <property name="contentRepository" ref="contentRepository" />
        <property name="publishRequestMapper" ref="publishRequestMapper" />
    </bean>

    <bean id="studioSyncDatabaseWithRepository" class="org.craftercms.studio.impl.v1.repository.job.SyncDatabaseWithRepository">
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="securityService" ref="cstudioSecurityService" />
        <property name="taskExecutor" ref="studioTaskExecutor" />
    </bean>

    <bean id="studioTaskExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor" destroy-method="shutdown">
        <property name="corePoolSize" value="5"/>
        <property name="maxPoolSize" value="10"/>
        <property name="queueCapacity" value="25"/>
        <property name="waitForTasksToCompleteOnShutdown" value="false" />
    </bean>

    <bean id="studioGroovyScriptExecutor" class="org.craftercms.studio.impl.v1.script.GroovyScriptExecutor" >
        <property name="scriptsClassPath" value="#{'${crafter-studio}/default-site'.split(',')}"/>
    </bean>

    <bean id="studioConfiguration" class="org.craftercms.studio.impl.v1.util.StudioConfigurationImpl"
          init-method="init"  depends-on="cstudioLogProvider">
        <property name="configLocation" value="crafter/studio/studio-config.yaml"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--         Asset Processing               -->
    <!-- ////////////////////////////////////// -->

    <bean id="studioImageMagickTransformer" class="org.craftercms.studio.impl.v1.asset.processing.ImageTransformingProcessor">
        <constructor-arg>
            <bean class="org.craftercms.studio.impl.v1.image.transformation.ImageMagickTransformer"/>
        </constructor-arg>
    </bean>

    <bean id="studioTinifyTransformer" class="org.craftercms.studio.impl.v1.asset.processing.ImageTransformingProcessor">
        <constructor-arg>
            <bean class="org.craftercms.studio.impl.v1.image.transformation.TinifyTransformer">
                <property name="apiKey"
                          value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_ASSET_PROCESSING_TINIFY_API_KEY)}"/>
            </bean>
        </constructor-arg>
    </bean>

    <bean id="studioAssetProcessorResolver" class="org.craftercms.studio.impl.v1.asset.processing.AssetProcessorResolverImpl">
        <property name="beanNameFormat" value="studio%s"/>
    </bean>

    <bean id="studioAssetProcessorPipelineResolver" class="org.craftercms.studio.impl.v1.asset.processing.AssetProcessorPipelineResolverImpl">
        <property name="processorResolver" ref="studioAssetProcessorResolver"/>
    </bean>

    <bean id="studioAssetProcessingConfigReader" class="org.craftercms.studio.impl.v1.asset.processing.AssetProcessingConfigReaderImpl"/>

    <bean id="studioAssetProcessingService" class="org.craftercms.studio.impl.v1.service.asset.processing.AssetProcessingServiceImpl">
        <property name="configPath"
                  value="#{studioConfiguration.getProperty(T(org.craftercms.studio.api.v1.util.StudioConfiguration).CONFIGURATION_SITE_ASSET_PROCESSING_CONFIGURATION_PATH)}"/>
        <property name="contentService" ref="cstudioContentService"/>
        <property name="configReader" ref="studioAssetProcessingConfigReader"/>
        <property name="pipelineResolver" ref="studioAssetProcessorPipelineResolver"/>
    </bean>

    <!-- ////////////////////////////////////// -->
    <!--              Entitlements              -->
    <!-- ////////////////////////////////////// -->
    <bean id="crafter.entitlementsProvider" class="org.craftercms.studio.impl.v1.entitlement.StudioEntitlementUsageProvider">
        <property name="objectMetadataManager" ref="cstudioObjectMetadataManager"/>
        <property name="siteService" ref="cstudioSiteServiceSimple"/>
        <property name="userServiceInternal" ref="userServiceInternal" />
    </bean>

    <import resource="classpath:crafter/studio/studio-security-context.xml"/>
</beans>